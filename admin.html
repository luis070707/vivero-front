<!-- admin.html: Panel de administración del Vivero Nuevo Renacer -->
<!DOCTYPE html>
<html lang="es">
<head>
  <!-- Configuración básica del documento y vista responsive -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Título de la pestaña del navegador -->
  <title>Panel Admin - Vivero Nuevo Renacer</title>

  <!-- Descripción corta para buscadores (SEO) -->
  <meta name="description" content="Panel de administración: categorías y productos." />

  <!-- Bootstrap + Icons: estilos base e iconos para todo el panel -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Estilos globales + ajustes pequeños específicos del panel -->
  <link rel="stylesheet" href="css/estilos.css">
  <style>
    .card-stat { border-radius: 1rem; }
    .table thead th { white-space: nowrap; }
    .cursor-pointer { cursor: pointer; }
    .prod-thumb { width:58px; height:44px; object-fit:cover; border-radius:6px; }
    .order-row td { vertical-align: middle; }
  </style>
</head>
<body>

  <!-- Navbar principal reutilizada en el panel de admin -->
  <nav class="navbar navbar-expand-lg navbar-dark shadow-sm">
    <div class="container">
      <!-- Logo + nombre que llevan al inicio público -->
      <a class="navbar-brand d-flex align-items-center gap-2" href="index.html">
        <img src="images/iconovivero.png" alt="Vivero Nuevo Renacer" class="brand-logo" loading="eager" decoding="async"/>
        <span>Vivero Nuevo Renacer</span>
      </a>

      <!-- Botón hamburguesa para ver el menú en móviles -->
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
              data-bs-target="#navbarNav" aria-controls="navbarNav"
              aria-expanded="false" aria-label="Mostrar navegación">
        <span class="navbar-toggler-icon"></span>
      </button>

      <!-- Menú de navegación superior -->
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-2">
          <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
          <li class="nav-item"><a class="nav-link" href="catalogo.html">Catálogo</a></li>
          <li class="nav-item"><a class="nav-link" href="index.html#contacto">Contacto</a></li>
          <li class="nav-item"><a class="nav-link" href="index.html#ubicacion">Ubicación</a></li>

          <!-- Dropdown de perfil para el usuario ADMIN (lo muestro con JS solo si tiene permisos) -->
          <li id="nav-profile" class="nav-item dropdown d-none ms-lg-2">
            <a class="nav-link dropdown-toggle no-caret d-flex align-items-center gap-2 nav-profile-trigger"
               href="#" role="button" data-bs-toggle="dropdown" data-bs-display="static" aria-expanded="false">
              <i class="bi bi-person-circle fs-5"></i>
              <span id="nav-username" class="d-none d-lg-inline">—</span>
              <i class="bi bi-caret-down-fill"></i>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li>
                <a class="dropdown-item d-flex align-items-center gap-2" href="perfil.html">
                  <i class="bi bi-person-gear"></i> Mi perfil
                </a>
              </li>
              <li>
                <a class="dropdown-item d-flex align-items-center gap-2" href="wishlist.html">
                  <i class="bi bi-heart"></i> Mis favoritos
                </a>
              </li>
              <li><hr class="dropdown-divider"></li>
              <li>
                <button class="dropdown-item text-danger d-flex align-items-center gap-2" id="btn-logout" type="button">
                  <i class="bi bi-box-arrow-right"></i> Cerrar sesión
                </button>
              </li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Contenido principal del panel de administración -->
  <main class="container my-4">
    <!-- Encabezado del panel -->
    <header class="mb-3">
      <h1 class="h4 mb-1">Panel de Administración</h1>
      <p class="text-muted mb-0">Gestiona categorías y productos.</p>
    </header>

    <!-- Mensaje de bloqueo si el usuario NO es admin (se maneja desde JS) -->
    <div id="guard" class="alert alert-danger d-none" role="alert">
      No tienes permisos para ver esta página. <a href="login.html" class="alert-link">Inicia sesión</a> con una cuenta de administrador.
    </div>

    <!-- Resumen de estadísticas rápidas: usuarios, productos y categorías -->
    <section id="summary" class="row g-3 mb-4 d-none">
      <div class="col-md-4">
        <div class="card card-stat shadow-sm">
          <div class="card-body d-flex align-items-center justify-content-between">
            <div>
              <div class="text-muted small">Usuarios</div>
              <div id="sum-users" class="fs-4 fw-semibold">—</div>
            </div>
            <i class="bi bi-people fs-2 text-success"></i>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card card-stat shadow-sm">
          <div class="card-body d-flex align-items-center justify-content-between">
            <div>
              <div class="text-muted small">Productos</div>
              <div id="sum-products" class="fs-4 fw-semibold">—</div>
            </div>
             <i class="bi bi-flower1 fs-2 text-success"></i>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card card-stat shadow-sm">
          <div class="card-body d-flex align-items-center justify-content-between">
            <div>
              <div class="text-muted small">Categorías</div>
              <div id="sum-categories" class="fs-4 fw-semibold">—</div>
            </div>
            <i class="bi bi-tags fs-2 text-success"></i>
          </div>
        </div>
      </div>
    </section>

    <!-- Pestañas del panel: categorías, productos, pedidos y reportes -->
    <ul class="nav nav-tabs mb-3" id="adminTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tab-cats" data-bs-toggle="tab" data-bs-target="#pane-cats" type="button" role="tab">Categorías</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-prods" data-bs-toggle="tab" data-bs-target="#pane-prods" type="button" role="tab">Productos</button>
      </li>
      <!-- Pestaña de pedidos (nuevo módulo) -->
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-orders" data-bs-toggle="tab" data-bs-target="#pane-orders" type="button" role="tab">Pedidos</button>
      </li>
      <!-- Pestaña de reportes (nuevo módulo) -->
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-reports" data-bs-toggle="tab" data-bs-target="#pane-reports" type="button" role="tab">Reportes</button>
      </li>
    </ul>

    <div class="tab-content">
      <!-- Sección de CATEGORÍAS: CRUD de categorías del catálogo -->
      <section class="tab-pane fade show active" id="pane-cats" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h2 class="h6 mb-0">Categorías</h2>
          <!-- Botón para abrir el modal de creación de nueva categoría -->
          <button id="btnNewCat" class="btn btn-custom btn-sm"><i class="bi bi-plus-circle"></i> Nueva categoría</button>
        </div>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th style="width:80px;">ID</th>
                <th>Nombre</th>
                <th>Slug</th>
                <th style="width:140px;">Acciones</th>
              </tr>
            </thead>
            <tbody id="catBody">
              <tr><td colspan="4" class="text-center text-muted py-4">Cargando…</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Sección de PRODUCTOS: búsqueda, filtro, paginación y CRUD de productos -->
      <section class="tab-pane fade" id="pane-prods" role="tabpanel">
        <div class="d-flex justify-content-between align-items-end mb-2 flex-wrap gap-2">
          <!-- Filtros de búsqueda de productos -->
          <div class="d-flex align-items-end gap-2 flex-grow-1">
            <div class="me-2" style="min-width:260px;">
              <label class="form-label small">Buscar</label>
              <input id="qProd" type="search" class="form-control" placeholder="Nombre o descripción…">
            </div>
            <div style="min-width:220px;">
              <label class="form-label small">Categoría</label>
              <select id="catFilter" class="form-select">
                <option value="">Todas</option>
              </select>
            </div>
            <div class="d-flex gap-2">
              <!-- Buscar según filtros actuales -->
              <button id="btnSearchProd" class="btn btn-outline-success"><i class="bi bi-search"></i> Buscar</button>
              <!-- Recargar listado de productos completo -->
              <button id="btnReloadProd" class="btn btn-outline-secondary"><i class="bi bi-arrow-repeat"></i> Recargar</button>
            </div>
          </div>
          <!-- Botón para abrir el modal de creación de producto -->
          <button id="btnNewProd" class="btn btn-custom"><i class="bi bi-plus-circle"></i> Nuevo producto</button>
        </div>

        <!-- Tabla principal de productos -->
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th style="width:70px;">ID</th>
                <th>Imagen</th>
                <th>Nombre</th>
                <th>Categoría</th>
                <th class="text-end" style="width:120px;">Precio</th>
                <th class="text-end" style="width:90px;">Stock</th>
                <th style="width:120px;">Acciones</th>
              </tr>
            </thead>
            <tbody id="prodBody">
              <tr><td colspan="7" class="text-center text-muted py-4">Cargando…</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Controles de paginación de productos -->
        <div class="d-flex justify-content-end align-items-center gap-2 mt-2">
          <button id="prevPage" class="btn btn-outline-secondary btn-sm">«</button>
          <span class="small">Página <span id="pageNum">1</span></span>
          <button id="nextPage" class="btn btn-outline-secondary btn-sm">»</button>
        </div>
      </section>

      <!-- Sección de PEDIDOS: listado y creación de pedidos internos -->
      <section class="tab-pane fade" id="pane-orders" role="tabpanel">
        <div class="d-flex justify-content-between align-items-end mb-2 flex-wrap gap-2">
          <!-- Filtros de pedidos por mes, año y búsqueda -->
          <div class="d-flex align-items-end gap-2 flex-wrap">
            <div>
              <label class="form-label small">Mes</label>
              <select id="ordMonth" class="form-select form-select-sm" style="min-width:150px;"></select>
            </div>
            <div>
              <label class="form-label small">Año</label>
              <select id="ordYear" class="form-select form-select-sm" style="min-width:120px;"></select>
            </div>
            <div>
              <label class="form-label small">Buscar</label>
              <input id="qOrder" type="search" class="form-control form-control-sm" placeholder="Cliente o #pedido">
            </div>
            <button id="btnSearchOrder" class="btn btn-outline-success btn-sm"><i class="bi bi-search"></i> Filtrar</button>
          </div>
          <!-- Botón para crear un pedido manualmente -->
          <button id="btnNewOrder" class="btn btn-custom"><i class="bi bi-journal-plus"></i> Nuevo pedido</button>
        </div>

        <!-- Tabla de pedidos -->
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th style="width:90px;">#</th>
                <th style="min-width:140px;">Fecha</th>
                <th>Cliente</th>
                <th class="text-end">Ítems</th>
                <th class="text-end">Total</th>
                <th style="width:120px;">Acciones</th>
              </tr>
            </thead>
            <tbody id="orderBody">
              <tr><td colspan="6" class="text-center text-muted py-4">Sin pedidos</td></tr>
            </tbody>
          </table>
        </div>

        <!-- ⭐ Nuevo: paginación de pedidos (solo frontend) -->
        <div class="d-flex justify-content-end align-items-center gap-2 mt-2">
          <button id="ordPrev" class="btn btn-outline-secondary btn-sm">«</button>
          <span class="small">
            Página <span id="ordPage">1</span> de <span id="ordPages">1</span>
          </span>
          <button id="ordNext" class="btn btn-outline-secondary btn-sm">»</button>
        </div>
      </section>

      <!-- Sección de REPORTES: gráficos de ventas y top productos con Chart.js -->
      <section class="tab-pane fade" id="pane-reports" role="tabpanel">
        <div class="row g-3">
          <!-- Gráfico principal de ventas por día/mes -->
          <div class="col-lg-7">
            <div class="card shadow-sm">
              <div class="card-body">
                <div class="d-flex align-items-end gap-2 flex-wrap mb-2">
                  <div>
                    <label class="form-label small">Ventas en:</label>
                    <select id="repMonth" class="form-select form-select-sm" style="min-width:160px;"></select>
                  </div>
                  <div>
                    <label class="form-label small">&nbsp;</label>
                    <select id="repYear" class="form-select form-select-sm" style="min-width:120px;"></select>
                  </div>
                  <!-- Botón para recargar datos del gráfico de ventas -->
                  <button id="btnReloadSales" class="btn btn-outline-secondary btn-sm ms-auto">
                    <i class="bi bi-arrow-repeat"></i> Recargar
                  </button>
                </div>
                <canvas id="salesChart" height="200"></canvas>
              </div>
            </div>
          </div>

          <!-- Gráfico de top productos vendidos -->
          <div class="col-lg-5">
            <div class="card shadow-sm">
              <div class="card-body">
                <div class="d-flex align-items-end gap-2 flex-wrap mb-2">
                  <div>
                    <label class="form-label small">Top plantas</label>
                    <select id="topPeriod" class="form-select form-select-sm" style="min-width:160px;">
                      <option value="month">Mes actual</option>
                      <option value="year">Este año</option>
                      <option value="all">Todo</option>
                    </select>
                  </div>
                  <!-- Filtros adicionales cuando se ve por mes/año -->
                  <div id="topFilters" class="d-flex align-items-end gap-2">
                    <select id="topMonth" class="form-select form-select-sm" style="min-width:140px;"></select>
                    <select id="topYear" class="form-select form-select-sm" style="min-width:120px;"></select>
                  </div>
                </div>
                <canvas id="topChart" height="200"></canvas>
              </div>
            </div>
          </div>
        </div>
      </section>

    </div>
  </main>

  <!-- Modal para crear/editar categorías -->
  <div class="modal fade" id="catModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form id="catForm" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="catModalTitle">Nueva categoría</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="catId">
          <div class="mb-3">
            <label for="catName" class="form-label">Nombre</label>
            <input type="text" id="catName" class="form-control" required maxlength="80">
          </div>
          <div class="mb-3">
            <label for="catSlug" class="form-label">Slug</label>
            <input type="text" id="catSlug" class="form-control" maxlength="80" placeholder="(opcional)">
            <div class="form-text">Si lo dejas vacío se genera a partir del nombre.</div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
          <button id="btnSaveCat" class="btn btn-custom" type="submit">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal para crear/editar productos -->
  <div class="modal fade" id="prodModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <form id="prodForm" class="modal-content" enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title" id="prodModalTitle">Nuevo producto</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="prodId">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Nombre</label>
              <input id="prodName" type="text" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Slug (opcional)</label>
              <input id="prodSlug" type="text" class="form-control">
            </div>
            <div class="col-12">
              <label class="form-label">Descripción</label>
              <textarea id="prodDesc" class="form-control" rows="3"></textarea>
            </div>
            <div class="col-md-4">
              <label class="form-label">Precio (COP)</label>
              <input id="prodPrice" type="number" step="0.01" min="0" class="form-control" placeholder="0.00">
            </div>
            <div class="col-md-4">
              <label class="form-label">Stock</label>
              <input id="prodStock" type="number" step="1" min="0" class="form-control" value="0">
            </div>
            <div class="col-md-4">
              <label class="form-label">Categoría</label>
              <select id="prodCategory" class="form-select">
                <option value="">(sin categoría)</option>
              </select>
            </div>
            <div class="col-md-8">
              <label class="form-label">Imagen (jpg, png, webp, gif; máx. 5MB)</label>
              <input id="prodImage" type="file" accept="image/*" class="form-control">
              <div class="form-text">Si eliges una imagen al editar, reemplaza la actual.</div>
            </div>
            <div class="col-md-4 d-flex align-items-end">
              <!-- Vista previa de la imagen actual del producto -->
              <img id="prodPreview" src="" alt="" class="prod-thumb d-none">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
          <button id="btnSaveProd" class="btn btn-custom" type="submit">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal para crear un pedido manual (nuevo módulo de pedidos) -->
  <div class="modal fade" id="orderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <form id="orderForm" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Nuevo pedido</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>

       <div class="modal-body">
  <!-- Datos básicos del cliente del pedido -->
  <div class="row g-2">
    <div class="col-md-6">
      <label class="form-label">Cliente (opcional)</label>
      <input id="ordCustomer" class="form-control" placeholder="Nombre del cliente">
    </div>
    <div class="col-md-6">
      <label class="form-label">Teléfono (opcional)</label>
      <input id="ordPhone" class="form-control" placeholder="Ej: 3001234567">
    </div>
    <div class="col-md-6">
      <label class="form-label">Fecha</label>
      <input id="ordDate" type="datetime-local" class="form-control">
    </div>
  </div>


          <hr class="my-3">

          <!-- Tabla dinámica de ítems del pedido -->
          <div class="d-flex justify-content-between align-items-center">
            <label class="form-label mb-0">Ítems</label>
            <button id="btnAddRow" type="button" class="btn btn-outline-success btn-sm">
              <i class="bi bi-plus-circle"></i> Agregar ítem
            </button>
          </div>

          <div class="table-responsive mt-2">
            <table class="table table-sm align-middle">
              <thead class="table-light">
                <tr>
                  <th>Producto</th>
                  <th style="width:120px;">Precio</th>
                  <th style="width:100px;">Cant.</th>
                  <th class="text-end" style="width:140px;">Subtotal</th>
                  <th style="width:50px;"></th>
                </tr>
              </thead>
              <tbody id="ordItems">
                <!-- Filas de productos del pedido se agregan con JS -->
              </tbody>
              <tfoot>
                <tr>
                  <td colspan="3" class="text-end fw-semibold">Total:</td>
                  <td class="text-end fw-semibold" id="ordTotal">$0</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>

          <!-- Lista de productos para autocompletar (datalist) -->
          <datalist id="prodList"></datalist>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-custom"><i class="bi bi-save"></i> Guardar pedido</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast de feedback general para acciones del panel -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1100;">
    <div id="toast" class="toast align-items-center border-0" role="status" aria-live="polite" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">Listo.</div>
        <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
      </div>
    </div>
  </div>

  <!-- Scripts base de Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Lógica principal del panel admin (categorías y productos) -->
  <script src="js/admin.js?v=20251028-1"></script>

  <!-- Librería Chart.js para los gráficos de reportes -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Módulo de pedidos y módulo de reportes (se apoyan en la API sin romper admin.js) -->
  <script src="js/orders.js?v=1"></script>
  <script src="js/reports.js?v=1"></script>
</body>
</html>
