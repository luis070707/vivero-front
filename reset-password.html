<!-- reset-password.html: Página para establecer una nueva contraseña -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Restablecer contraseña - Vivero Nuevo Renacer</title>

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Estilos globales del sitio -->
  <link rel="stylesheet" href="css/estilos.css">
  <link rel="stylesheet" href="css/auth.css">
</head>
<body>

  <!-- Navbar igual que en login -->
  <nav class="navbar navbar-expand-lg navbar-dark shadow-sm">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center gap-2" href="index.html">
        <img
          src="images/iconovivero.png"
          alt="Vivero Nuevo Renacer"
          class="brand-logo"
          loading="eager"
          decoding="async"
        />
        <span>Vivero Nuevo Renacer</span>
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
              data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Mostrar navegación">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-2">
          <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
          <li class="nav-item"><a class="nav-link" href="catalogo.html">Catálogo</a></li>
          <li class="nav-item"><a class="nav-link active" aria-current="page" href="#">Restablecer contraseña</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Contenido principal -->
  <main class="py-4 bg-light">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6 col-xl-5">
          <section class="auth-card">
            <div class="auth-card__inner">
              <div class="text-center mb-3">
                <div class="brand-mark">
                  <img src="images/iconoviveroo.png"
                       alt="Logo Vivero Nuevo Renacer"
                       class="brand-mark__img">
                </div>
                <h1 class="h4 mb-1">Restablecer contraseña</h1>
                <p class="text-muted small mb-0">
                  Elige una nueva contraseña para tu cuenta.
                </p>
              </div>

              <!-- Alerta si no viene token en la URL -->
              <div id="tokenAlert" class="alert alert-danger d-none" role="alert">
                El enlace de recuperación es inválido. Intenta solicitar uno nuevo desde la página de inicio de sesión.
              </div>

              <!-- Formulario de nueva contraseña -->
              <form id="resetForm" class="needs-validation" novalidate>
                <div class="form-floating mb-3">
                  <input type="password" class="form-control" id="newPassword"
                         placeholder="Nueva contraseña" required minlength="6" maxlength="72" autocomplete="new-password">
                  <label for="newPassword">Nueva contraseña</label>
                  <div class="invalid-feedback">
                    La contraseña debe tener al menos 6 caracteres.
                  </div>
                </div>

                <div class="form-floating mb-3">
                  <input type="password" class="form-control" id="confirmPassword"
                         placeholder="Repetir contraseña" required minlength="6" maxlength="72" autocomplete="new-password">
                  <label for="confirmPassword">Repetir contraseña</label>
                  <div class="invalid-feedback">
                    Repite la contraseña para confirmar.
                  </div>
                </div>

                <!-- Botón para mostrar/ocultar contraseña opcional -->
                <div class="d-flex justify-content-end mb-3">
                  <button type="button" class="btn btn-sm btn-outline-secondary" id="togglePasswords">
                    <i class="bi bi-eye"></i> Mostrar/ocultar
                  </button>
                </div>

                <div class="d-grid gap-2">
                  <button id="btnReset" class="btn btn-custom" type="submit">
                    <span class="btn-label">Guardar nueva contraseña</span>
                    <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
                  </button>
                  <a href="login.html" class="btn btn-outline-secondary">Volver al inicio de sesión</a>
                </div>
              </form>
            </div>
          </section>
        </div>
      </div>
    </div>
  </main>

  <!-- Toast para mensajes -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1100;">
    <div id="toastReset" class="toast align-items-center border-0" role="status" aria-live="polite" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">Listo.</div>
        <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  (function () {
    // URL base de la API (misma que uses en login)
    const API = 'https://vivero-back.onrender.com';

    const params = new URLSearchParams(window.location.search);
    const token = params.get('token') || '';

    const form = document.getElementById('resetForm');
    const pw1  = document.getElementById('newPassword');
    const pw2  = document.getElementById('confirmPassword');
    const btn  = document.getElementById('btnReset');
    const spinner = btn.querySelector('.spinner-border');
    const tokenAlert = document.getElementById('tokenAlert');

    const toastEl = document.getElementById('toastReset');
    const toast = new bootstrap.Toast(toastEl);

    function showToast(msg, type = 'success') {
      const body = toastEl.querySelector('.toast-body');
      body.textContent = msg;
      toastEl.classList.remove('bg-danger','bg-success','text-white');
      if (type === 'success') toastEl.classList.add('bg-success','text-white');
      else toastEl.classList.add('bg-danger','text-white');
      toast.show();
    }

    // Si no hay token en la URL, bloqueo el formulario
    if (!token) {
      tokenAlert.classList.remove('d-none');
      form.classList.add('d-none');
      return;
    }

    // Mostrar/ocultar contraseñas
    document.getElementById('togglePasswords').addEventListener('click', () => {
      const inputs = [pw1, pw2];
      const show = inputs[0].type === 'password';
      inputs.forEach(i => i.type = show ? 'text' : 'password');
      const icon = document.querySelector('#togglePasswords i');
      icon.classList.toggle('bi-eye');
      icon.classList.toggle('bi-eye-slash');
      pw1.focus();
    });

    // Enviar nueva contraseña
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      form.classList.add('was-validated');

      if (!form.checkValidity()) return;

      if (pw1.value !== pw2.value) {
        showToast('Las contraseñas no coinciden.', 'danger');
        return;
      }

      btn.disabled = true;
      spinner.classList.remove('d-none');

      try {
        const res = await fetch(API + '/api/auth/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token, password: pw1.value })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'No se pudo restablecer la contraseña');

        showToast(data.message || 'Tu contraseña se actualizó correctamente.');
        setTimeout(() => { window.location.href = 'login.html'; }, 1200);
      } catch (err) {
        showToast(err.message || 'Ocurrió un error al restablecer tu contraseña.', 'danger');
      } finally {
        btn.disabled = false;
        spinner.classList.add('d-none');
      }
    });
  })();
  </script>
</body>
</html>
