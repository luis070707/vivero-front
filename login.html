<!-- login.html: P치gina de inicio de sesi칩n de usuarios del Vivero Nuevo Renacer -->
<!DOCTYPE html>
<html lang="es">
<head>
  <!-- Configuraci칩n b치sica de codificaci칩n y comportamiento responsive -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- T칤tulo que se muestra en la pesta침a del navegador -->
  <title>Iniciar sesi칩n - Vivero Nuevo Renacer</title>

  <!-- Descripci칩n para SEO (texto que leen los buscadores) -->
  <meta name="description" content="Accede a tu cuenta para comprar y administrar tus pedidos en Vivero La Ceiba." />

  <!-- Bootstrap + Icons: estilos base y set de iconos -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Estilos globales del sitio y espec칤ficos de pantallas de auth (login/registro) -->
  <link rel="stylesheet" href="css/estilos.css">
  <link rel="stylesheet" href="css/auth.css">
</head>
<body>

  <!-- Navbar -->
  <!-- Barra de navegaci칩n superior con acceso a inicio, cat치logo y login -->
  <nav class="navbar navbar-expand-lg navbar-dark shadow-sm">
    <div class="container">
      <!-- Marca del sitio: logo + nombre que llevan al inicio -->
      <a class="navbar-brand d-flex align-items-center gap-2" href="index.html">
        <img
          src="images/iconovivero.png"
          alt="Vivero Nuevo Renacer"
          class="brand-logo"
          loading="eager"
          decoding="async"
        />
        <span>Vivero Nuevo Renacer</span>
      </a>

      <!-- Bot칩n hamburguesa para colapsar/mostrar el men칰 en pantallas peque침as -->
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
              data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Mostrar navegaci칩n">
        <span class="navbar-toggler-icon"></span>
      </button>

      <!-- Enlaces de navegaci칩n -->
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-2">
          <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
          <li class="nav-item"><a class="nav-link" href="catalogo.html">Cat치logo</a></li>
          <!-- Enlace actual: p치gina de Login marcada como activa -->
          <li class="nav-item"><a class="nav-link active" aria-current="page" href="#">Login</a></li>
        </ul>
      </div>
    </div>
  </nav>


  <!-- Canvas del login -->
  <!-- Contenedor principal del dise침o de autenticaci칩n (lado visual + tarjeta de login) -->
  <main class="auth-canvas">
    <div class="container-auth">
      <!-- Panel visual (desktop) -->
      <!-- Este aside solo se ve en pantallas grandes y sirve de panel informativo/ilustrativo -->
      <aside class="auth-visual d-none d-lg-flex">
        <!-- Capa de color/sombra por encima de la imagen de fondo (definida en CSS) -->
        <div class="visual-overlay"></div>
        <div class="visual-content">
          <!-- Insignia con icono para reforzar la tem치tica del vivero -->
          <div class="visual-badge">游꺔</div>
          <h2>춰Nos alegra verte!</h2>
          <p class="text-opacity">Accede para comprar m치s r치pido, guardar tu lista de deseos y seguir tus pedidos.</p>
          <!-- Lista de beneficios que el usuario obtiene al iniciar sesi칩n -->
          <ul class="benefits">
            <li><i class="bi bi-bag-check"></i> Pagos y env칤os m치s 치giles</li>
            <li><i class="bi bi-heart"></i> Lista de Deseos y recomendaciones</li>
            <li><i class="bi bi-headset"></i> Soporte y asesor칤a</li>
          </ul>
        </div>
      </aside>

      <!-- Tarjeta de acceso -->
      <!-- Secci칩n principal donde el usuario ingresa sus credenciales -->
      <section class="auth-card">
        <div class="auth-card__inner">
          <!-- Encabezado de la tarjeta de login -->
          <div class="text-center mb-3">
            <!-- Marca visual: aqu칤 uso mi logo redondo del vivero -->
            <div class="brand-mark">
              <!-- Meto el logo dentro del circulito para que quede centrado -->
              <img src="images/iconoviveroo.png"
                   alt="Logo Vivero Nuevo Renacer"
                   class="brand-mark__img">
            </div>
            <h1 class="h4 mb-1">Iniciar sesi칩n</h1>
            <p class="text-muted small mb-0">Bienvenido de vuelta</p>
          </div>

          <!-- Formulario de inicio de sesi칩n -->
          <!-- Uso validaci칩n nativa HTML5 + clases de Bootstrap -->
          <form id="loginForm" class="needs-validation" novalidate>
            <!-- Usuario / Email -->
            <!-- Campo donde el usuario puede escribir su usuario o correo -->
            <div class="form-floating mb-3 position-relative">
              <input type="text" class="form-control" id="loginIdentifier" placeholder="usuario o correo"
                     required autocomplete="username" maxlength="80">
              <label for="loginIdentifier">Usuario o correo</label>
              <div class="invalid-feedback">Ingresa tu usuario o un correo v치lido.</div>
            </div>

            <!-- Contrase침a + ojo fuera del campo -->
            <!-- Agrupo campo de contrase침a + bot칩n de ojo en una sola fila -->
            <div class="d-flex align-items-stretch gap-2 mb-1">
              <!-- Campo de contrase침a como floating label -->
              <div class="form-floating flex-grow-1 position-relative">
                <input type="password" class="form-control" id="loginPassword" placeholder="Contrase침a"
                       required autocomplete="current-password" minlength="6" maxlength="72">
                <label for="loginPassword">Contrase침a</label>
                <div class="invalid-feedback">La contrase침a es obligatoria (m칤nimo 6 caracteres).</div>
              </div>
              <!-- Bot칩n para mostrar/ocultar la contrase침a (ojo) -->
              <button type="button" class="btn btn-eye" id="togglePassword"
                      aria-label="Mostrar u ocultar contrase침a"
                      style="border:none;outline:none;box-shadow:none">
                <i class="bi bi-eye"></i>
              </button>
            </div>

            <!-- Aviso cuando Bloq May칰s est치 activo mientras se escribe la contrase침a -->
            <div id="capsWarning" class="form-text text-warning small d-none mt-2">
              <i class="bi bi-exclamation-triangle"></i> Bloq May칰s activado.
            </div>

            <!-- Opciones -->
            <!-- Aqu칤 solo dejo el enlace de "쯆lvidaste tu contrase침a?" alineado a la derecha -->
            <div class="d-flex justify-content-end my-3">
              <!-- Bot칩n que abre el modal de recuperar contrase침a -->
              <button class="btn btn-link p-0 text-decoration-none" type="button" data-bs-toggle="modal" data-bs-target="#recoverModal">
                쯆lvidaste tu contrase침a?
              </button>
            </div>

            <!-- Botones -->
            <!-- Bot칩n principal de login + enlace a la p치gina de registro -->
            <div class="d-grid gap-2 mt-2">
              <!-- Bot칩n de enviar formulario con spinner integrado -->
              <button id="btnLogin" class="btn btn-custom" type="submit">
                <span class="btn-label">Iniciar sesi칩n</span>
                <!-- Spinner que muestro mientras realizo la petici칩n al backend -->
                <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
              </button>
              <!-- Enlace para ir a crear una nueva cuenta -->
              <a href="registro.html" class="btn btn-outline-success">Crear cuenta</a>
            </div>
          </form>

          <!-- Aviso legal de t칠rminos y privacidad -->
          <p class="text-center mt-3 small text-muted">
            Al continuar aceptas nuestros <a href="terminos.html" class="link-success">T칠rminos</a> y <a href="privacidad.html" class="link-success">Privacidad</a>.
          </p>
        </div>
      </section>
    </div>
  </main>

  <!-- Modal: Recuperar contrase침a -->
  <!-- Modal donde el usuario pone su correo para recibir un enlace de recuperaci칩n -->
  <div class="modal fade" id="recoverModal" tabindex="-1" aria-labelledby="recoverLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <!-- Formulario interno del modal -->
        <form id="recoverForm" novalidate>
          <div class="modal-header">
            <h5 class="modal-title" id="recoverLabel">Recuperar contrase침a</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <!-- Campo para que el usuario escriba su correo -->
            <div class="form-floating">
              <input type="email" class="form-control" id="recoverEmail" placeholder="correo@ejemplo.com" required>
              <label for="recoverEmail">Correo electr칩nico</label>
              <div class="invalid-feedback">Ingresa un correo v치lido para enviarte el enlace.</div>
            </div>
          </div>
          <div class="modal-footer">
            <!-- Bot칩n para cerrar el modal sin hacer nada -->
            <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
            <!-- Bot칩n que dispara el flujo de recuperaci칩n -->
            <button id="btnRecover" class="btn btn-custom" type="submit">
              <span class="btn-label">Enviar enlace</span>
              <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <!-- Contenedor para mostrar notificaciones flotantes (칠xito/error) -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1100;">
    <div id="toastAuth" class="toast align-items-center border-0" role="status" aria-live="polite" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">Listo.</div>
        <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <!-- Script de Bootstrap (JS) para manejar modales, toasts, etc. -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Script de login: maneja validaci칩n, ojo, Bloq May칰s, llamada al backend y recuperaci칩n -->
  <script>
  (function(){
   // URL base de mi API backend 
   const API = 'https://vivero-back.onrender.com';

    // Referencias a los elementos del DOM que voy a usar
    const form = document.getElementById('loginForm');
    const inputId = document.getElementById('loginIdentifier');
    const inputPw = document.getElementById('loginPassword');
    const btnLogin = document.getElementById('btnLogin');
    const spinner = btnLogin.querySelector('.spinner-border');

    // Configuraci칩n del toast para mostrar mensajes de feedback
    const toastEl = document.getElementById('toastAuth');
    const toast = new bootstrap.Toast(toastEl);

    // Funci칩n reutilizable para mostrar el toast con mensaje y tipo (칠xito o error)
    function showToast(msg, type='success'){
      const body = toastEl.querySelector('.toast-body');
      body.textContent = msg;
      // Limpio clases previas de color
      toastEl.classList.remove('bg-danger','bg-success','text-white');
      // Aplico clases seg칰n el tipo
      if(type==='success'){ toastEl.classList.add('bg-success','text-white'); }
      else { toastEl.classList.add('bg-danger','text-white'); }
      toast.show();
    }

    // Validaci칩n HTML5 + Bootstrap
    // Manejador del env칤o del formulario de login
    form.addEventListener('submit', async (e) => {
      e.preventDefault(); // Evito el env칤o normal del formulario
      form.classList.add('was-validated'); // Activo estilos de validaci칩n de Bootstrap

      // Si el formulario no cumple validaciones HTML5, no sigo
      if (!form.checkValidity()) return;

      // Deshabilito el bot칩n y muestro el spinner mientras hago la petici칩n
      btnLogin.disabled = true;
      spinner.classList.remove('d-none');

      const identifier = inputId.value.trim();
      const password = inputPw.value;

      try {
        // Llamada al endpoint de login de mi backend
        const res = await fetch(API + '/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ identifier, password })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Error al iniciar sesi칩n');

        // Aqu칤 guardo la sesi칩n siempre en sessionStorage (solo mientras la pesta침a est칠 abierta)
        sessionStorage.setItem('token', data.token);
        sessionStorage.setItem('user', JSON.stringify(data.user));

        // Muestro mensaje de 칠xito y redirijo al inicio despu칠s de un corto tiempo
        showToast('춰Sesi칩n iniciada!');
        setTimeout(() => { window.location.href = 'index.html'; }, 800);
      } catch (err) {
        // Si algo falla, muestro error en el toast
        showToast(err.message || 'Credenciales inv치lidas', 'danger');
      } finally {
        // Restauro el bot칩n y oculto el spinner sin importar si sali칩 bien o mal
        btnLogin.disabled = false;
        spinner.classList.add('d-none');
      }
    });

    // Ojo de contrase침a (fuera del campo)
    // Alterno entre mostrar la contrase침a en texto y ocultarla
    document.getElementById('togglePassword').addEventListener('click', () => {
      const isText = inputPw.type === 'text';
      inputPw.type = isText ? 'password' : 'text';
      const icon = document.querySelector('#togglePassword i');
      // Cambio el icono seg칰n el estado (ojo abierto/cerrado)
      icon.classList.toggle('bi-eye');
      icon.classList.toggle('bi-eye-slash');
      inputPw.focus();
    });

    // Aviso de Bloq May칰s
    // Detecto si el usuario tiene activado el CapsLock al escribir la contrase침a
    inputPw.addEventListener('keyup', (e) => {
      const on = e.getModifierState && e.getModifierState('CapsLock');
      document.getElementById('capsWarning').classList.toggle('d-none', !on);
    });

    // Recuperar contrase침a (ahora s칤 llamo a mi backend)
    // Aqu칤 conecto el modal de "recuperar contrase침a" con la API del backend
    const recoverForm = document.getElementById('recoverForm');
    const btnRecover = document.getElementById('btnRecover');
    const spinnerRecover = btnRecover.querySelector('.spinner-border');

    recoverForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      // Activo la validaci칩n visual de Bootstrap
      recoverForm.classList.add('was-validated');

      // Si el formulario no pasa las validaciones HTML5, no sigo
      if (!recoverForm.checkValidity()) return;

      // Tomo el correo ya validado
      const emailInput = document.getElementById('recoverEmail');
      const email = emailInput.value.trim();

      // Desactivo el bot칩n y muestro el spinner del modal
      btnRecover.disabled = true;
      spinnerRecover.classList.remove('d-none');

      try {
        // Hago la petici칩n al endpoint de "olvid칠 mi contrase침a" de mi backend
        const res = await fetch(API + '/api/auth/forgot-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'No se pudo enviar el correo de recuperaci칩n');

        // Si todo sali칩 bien, cierro el modal
        const modalEl = document.getElementById('recoverModal');
        const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
        modal.hide();

        // Limpio el formulario del modal
        recoverForm.reset();
        recoverForm.classList.remove('was-validated');

        // Muestro un mensaje amistoso al usuario
        showToast(data.message || 'Listo, revisa tu correo para continuar con el cambio de contrase침a.');
      } catch (err) {
        // Si algo falla, aviso con un toast de error
        showToast(err.message || 'Ocurri칩 un error al recuperar la contrase침a.', 'danger');
      } finally {
        // Siempre reactivo el bot칩n y oculto el spinner
        btnRecover.disabled = false;
        spinnerRecover.classList.add('d-none');
      }
    });

  })();
  </script>

</body>
</html>
