<!-- registro.html: P√°gina para crear cuenta de usuario en Vivero Nuevo Renacer -->
<DOCTYPE html>
<html lang="es">
<head>
  <!-- Configuraci√≥n b√°sica de codificaci√≥n y dise√±o responsive -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- T√≠tulo que aparece en la pesta√±a del navegador -->
  <title>Crear cuenta - Vivero Nuevo Renacer</title>

  <!-- Descripci√≥n para buscadores/SEO -->
  <meta name="description" content="Crea tu cuenta para comprar, guardar tu lista de deseos y gestionar tus pedidos en Vivero La Ceiba." />

  <!-- Bootstrap + Icons: estilos base y set de iconos para toda la p√°gina -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Estilos globales y espec√≠ficos de login/registro -->
  <link rel="stylesheet" href="css/estilos.css">
  <link rel="stylesheet" href="css/auth.css">
</head>
<body>

 
 <!-- Navbar: barra de navegaci√≥n superior -->
 <nav class="navbar navbar-expand-lg navbar-dark shadow-sm">
  <div class="container">
    <!-- Logo + nombre del vivero que redirige al inicio -->
    <a class="navbar-brand d-flex align-items-center gap-2" href="index.html">
      <img
        src="images/iconovivero.png"
        alt="Vivero Nuevo Renacer"
        class="brand-logo"
        loading="eager"
        decoding="async"
      />
      <span>Vivero Nuevo Renacer</span>
    </a>

    <!-- Bot√≥n hamburguesa para colapsar el men√∫ en pantallas peque√±as -->
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
            data-bs-target="#navbarNav" aria-controls="navbarNav"
            aria-expanded="false" aria-label="Mostrar navegaci√≥n">
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- Links de navegaci√≥n -->
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-2">
        <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
        <li class="nav-item"><a class="nav-link" href="catalogo.html">Cat√°logo</a></li>
        <!-- P√°gina actual: registro marcada como activa -->
        <li class="nav-item"><a class="nav-link active" aria-current="page" href="#">Registro</a></li>
        <!-- Eliminados: enlace a Login y bot√≥n de modo oscuro -->
      </ul>
    </div>
  </div>
</nav>


  <!-- Canvas del registro: layout principal con panel visual + tarjeta -->
  <main class="auth-canvas">
    <div class="container-auth">
      <!-- Panel visual en el lado izquierdo (solo en pantallas grandes) -->
      <aside class="auth-visual d-none d-lg-flex" style="background-image:url('images/fondo3.jpeg')">
        <!-- Capa de oscurecimiento/overlay sobre la imagen -->
        <div class="visual-overlay"></div>
        <div class="visual-content">
          <!-- Insignia con icono para reforzar la tem√°tica -->
          <div class="visual-badge">ü™¥</div>
          <h2>¬°Crea tu cuenta!</h2>
          <p class="text-opacity">Compra m√°s r√°pido, guarda tus plantas favoritas y recibe recomendaciones.</p>
          <!-- Lista de beneficios de tener cuenta -->
          <ul class="benefits">
            <li><i class="bi bi-gift"></i> Ofertas y cupones exclusivos</li>
            <li><i class="bi bi-heart"></i> Lista de deseos sincronizada</li>
            <li><i class="bi bi-box-seam"></i> Seguimiento de pedidos</li>
          </ul>
        </div>
      </aside>

      <!-- Tarjeta de registro (formulario principal) -->
      <section class="auth-card">
        <div class="auth-card__inner">
          <!-- Encabezado de la tarjeta -->
          <div class="text-center mb-3">
            <!-- Marca visual redonda manejada por CSS -->
           <div class="brand-mark">
              <!-- Meto el logo dentro del circulito para que quede centrado -->
              <img src="images/iconoviveroo.png"
                   alt="Logo Vivero Nuevo Renacer"
                   class="brand-mark__img">
            </div>
            <h1 class="h4 mb-1">Crear cuenta</h1>
            <p class="text-muted small mb-0">√önete a Vivero Nuevo Renacer</p>
          </div>

          <!-- Formulario de registro -->
          <form id="registerForm" class="needs-validation" novalidate>
            <!-- Nombre completo (opcional, no obligatorio para el backend) -->
            <div class="form-floating mb-3">
              <input type="text" class="form-control" id="fullName" placeholder="Nombre completo" maxlength="80">
              <label for="fullName">Nombre completo (opcional)</label>
            </div>

            <!-- Usuario (requerido por backend) -->
            <div class="form-floating mb-3">
              <input type="text" class="form-control" id="regUsername" placeholder="usuario" required minlength="3" maxlength="40" autocomplete="username">
              <label for="regUsername">Nombre de usuario</label>
              <div class="invalid-feedback">M√≠nimo 3 caracteres (sin espacios).</div>
            </div>

            <!-- Correo electr√≥nico -->
            <div class="form-floating mb-3">
              <input type="email" class="form-control" id="regEmail" placeholder="correo@ejemplo.com" required maxlength="120" autocomplete="email">
              <label for="regEmail">Correo electr√≥nico</label>
              <div class="invalid-feedback">Ingresa un correo v√°lido.</div>
            </div>

            <!-- Contrase√±a + bot√≥n de ojo fuera del input -->
            <div class="d-flex align-items-stretch gap-2 mb-2">
              <div class="form-floating flex-grow-1">
                <input type="password" class="form-control" id="regPassword" placeholder="Contrase√±a" required minlength="6" maxlength="72" autocomplete="new-password">
                <label for="regPassword">Contrase√±a</label>
                <div class="invalid-feedback">M√≠nimo 6 caracteres.</div>
              </div>
              <!-- Bot√≥n para mostrar/ocultar la contrase√±a -->
              <button type="button" class="btn btn-eye" id="toggleRegPassword" aria-label="Mostrar u ocultar contrase√±a" style="border:none;outline:none;box-shadow:none">
                <i class="bi bi-eye"></i>
              </button>
            </div>

            <!-- Confirmar contrase√±a + bot√≥n de ojo fuera -->
            <div class="d-flex align-items-stretch gap-2">
              <div class="form-floating flex-grow-1">
                <input type="password" class="form-control" id="regConfirm" placeholder="Confirmar contrase√±a" required minlength="6" maxlength="72" autocomplete="new-password">
                <label for="regConfirm">Confirmar contrase√±a</label>
                <div class="invalid-feedback">Las contrase√±as no coinciden.</div>
              </div>
              <!-- Bot√≥n para mostrar/ocultar la confirmaci√≥n -->
              <button type="button" class="btn btn-eye" id="toggleRegConfirm" aria-label="Mostrar u ocultar confirmaci√≥n" style="border:none;outline:none;box-shadow:none">
                <i class="bi bi-eye"></i>
              </button>
            </div>

            <!-- Medidor visual de fuerza de la contrase√±a -->
            <div class="strength mt-2" aria-live="polite">
              <div class="strength-bar" id="strengthBarReg"></div>
              <span id="strengthLabelReg" class="strength-label">Fuerza: ‚Äî</span>
            </div>

            <!-- Aviso cuando Bloq May√∫s est√° activado -->
            <div id="capsWarningReg" class="form-text text-warning small d-none mt-2">
              <i class="bi bi-exclamation-triangle"></i> Bloq May√∫s activado.
            </div>

            <!-- Aceptaci√≥n de t√©rminos y pol√≠tica de privacidad -->
            <div class="form-check mt-3">
              <input class="form-check-input" type="checkbox" id="termsCheck" required>
              <label class="form-check-label" for="termsCheck">
                Acepto los <a href="terminos.html" class="link-success">T√©rminos</a> y la <a href="privacidad.html" class="link-success">Pol√≠tica de Privacidad</a>.
              </label>
              <div class="invalid-feedback">Debes aceptar los t√©rminos para continuar.</div>
            </div>

            <!-- Botones de acci√≥n -->
            <div class="d-grid gap-2 mt-3">
              <!-- Bot√≥n principal para crear cuenta (con spinner de carga) -->
              <button id="btnRegister" class="btn btn-custom" type="submit">
                <span class="btn-label">Crear cuenta</span>
                <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
              </button>
              <!-- Link para usuarios que ya tienen una cuenta -->
              <a href="login.html" class="btn btn-outline-success">Ya tengo cuenta</a>
            </div>
          </form>
        </div>
      </section>
    </div>
  </main>

  <!-- Toasts: notificaci√≥n flotante para mostrar mensajes de √©xito/error -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1100;">
    <div id="toastAuth" class="toast align-items-center border-0" role="status" aria-live="polite" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">Listo.</div>
        <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
      </div>
    </div>
  </div>

  <!-- Scripts de la p√°gina -->
  <!-- Bootstrap JS (para toasts, modales, etc.) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- L√≥gica de registro -->
  <script>
  (function(){
    // URL base de la API del backend
    const API = 'https://vivero-back.onrender.com'; // coincide con tu Live Server 127.0.0.1:5500

    // Referencias al formulario y bot√≥n de registro
    const form = document.getElementById('registerForm');
    const btn = document.getElementById('btnRegister');
    const spinner = btn.querySelector('.spinner-border');

    // Inputs que necesito para armar el payload de registro
    const inputUsername = document.getElementById('regUsername');
    const inputEmail    = document.getElementById('regEmail');
    const inputPw       = document.getElementById('regPassword');
    const inputConf     = document.getElementById('regConfirm');
    const terms         = document.getElementById('termsCheck');

    // Configuraci√≥n del toast de feedback
    const toastEl = document.getElementById('toastAuth');
    const toast = new bootstrap.Toast(toastEl);

    // Funci√≥n gen√©rica para mostrar mensajes en el toast (√©xito o error)
    function showToast(msg, type='success'){
      const body = toastEl.querySelector('.toast-body');
      body.textContent = msg;
      toastEl.classList.remove('bg-danger','bg-success','text-white');
      if(type==='success'){ toastEl.classList.add('bg-success','text-white'); }
      else { toastEl.classList.add('bg-danger','text-white'); }
      toast.show();
    }

    // Helpers
    // Calcula un ‚Äúpuntaje‚Äù b√°sico de fuerza de contrase√±a
    function score(pw){
      let s=0; if(pw.length>=6) s++; if(pw.length>=10) s++; if(/[A-Z]/.test(pw)) s++; if(/[0-9]/.test(pw)) s++; if(/[^A-Za-z0-9]/.test(pw)) s++; return s;
    }

    // Submit
    // Manejo el env√≠o del formulario de registro
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      form.classList.add('was-validated'); // activo estilos de validaci√≥n de Bootstrap

      // Regla extra: username >= 3 caracteres
      if (inputUsername.value.trim().length < 3) inputUsername.setCustomValidity('short');
      else inputUsername.setCustomValidity('');

      // Regla extra: contrase√±as deben coincidir
      if (inputPw.value !== inputConf.value) inputConf.setCustomValidity('mismatch');
      else inputConf.setCustomValidity('');

      // T√©rminos deben estar marcados
      if (!terms.checked) terms.setCustomValidity('no'); else terms.setCustomValidity('');

      // Si el formulario no pasa validaciones, no env√≠o nada al backend
      if (!form.checkValidity()) return;

      // Deshabilito bot√≥n y muestro spinner mientras hago la petici√≥n
      btn.disabled = true; spinner.classList.remove('d-none');

      // Normaliza email (reemplaza NBSP y recorta espacios)
      const rawEmail = inputEmail.value || '';
      const email = rawEmail.replace(/\u00A0/g,' ').trim();

      // Objeto que le env√≠o al backend para crear el usuario
      const payload = {
        email,
        username: inputUsername.value.trim(),
        password: inputPw.value
      };

      try {
        // Llamada al endpoint de registro en el backend
        const res = await fetch(API + '/api/auth/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'No se pudo crear la cuenta');

        // Inicia sesi√≥n autom√°ticamente al crear la cuenta
        sessionStorage.setItem('token', data.token);
        sessionStorage.setItem('user', JSON.stringify(data.user));

        // Mensaje de √©xito y redirecci√≥n al inicio
        showToast('¬°Cuenta creada con √©xito!');
        setTimeout(() => { window.location.href = 'index.html'; }, 800);
      } catch (err) {
        // Si algo falla, informo al usuario mediante el toast
        showToast(err.message || 'Error de registro', 'danger');
      } finally {
        // Restaura el estado del bot√≥n y oculta el spinner
        btn.disabled = false; spinner.classList.add('d-none');
      }
    });

    // Ojos de password
    // Alterna visibilidad de la contrase√±a principal
    document.getElementById('toggleRegPassword').addEventListener('click', () => {
      const isText = inputPw.type === 'text';
      inputPw.type = isText ? 'password' : 'text';
      const icon = document.querySelector('#toggleRegPassword i'); icon.classList.toggle('bi-eye'); icon.classList.toggle('bi-eye-slash');
      inputPw.focus();
    });
    // Alterna visibilidad de la confirmaci√≥n de contrase√±a
    document.getElementById('toggleRegConfirm').addEventListener('click', () => {
      const isText = inputConf.type === 'text';
      inputConf.type = isText ? 'password' : 'text';
      const icon = document.querySelector('#toggleRegConfirm i'); icon.classList.toggle('bi-eye'); icon.classList.toggle('bi-eye-slash');
      inputConf.focus();
    });

    // Bloq May√∫s + fuerza
    const caps = document.getElementById('capsWarningReg');
    const bar  = document.getElementById('strengthBarReg');
    const label= document.getElementById('strengthLabelReg');

    // Aviso cuando el usuario tiene activado CapsLock al escribir la contrase√±a
    inputPw.addEventListener('keyup', (e) => {
      const on = e.getModifierState && e.getModifierState('CapsLock');
      caps.classList.toggle('d-none', !on);
    });

    // Actualizo barra y texto de fuerza cada vez que cambia la contrase√±a
    inputPw.addEventListener('input', () => {
      const s = score(inputPw.value);
      const pct = Math.min(s*20,100);
      bar.style.width = pct + '%';
      bar.classList.remove('bg-danger','bg-warning','bg-success');
      if (s<=2){ bar.classList.add('bg-danger'); label.textContent='Fuerza: d√©bil'; }
      else if (s===3){ bar.classList.add('bg-warning'); label.textContent='Fuerza: media'; }
      else { bar.classList.add('bg-success'); label.textContent='Fuerza: fuerte'; }
      if (!inputPw.value){ label.textContent='Fuerza: ‚Äî'; bar.style.width='0%'; bar.classList.remove('bg-danger','bg-warning','bg-success'); }
    });
  })();
  </script>
</body>
</html>
